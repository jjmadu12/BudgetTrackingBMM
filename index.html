<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitoreo Presupuesto Proyecto</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6; /* Light gray background */
        padding: 20px;
        color: #333;
    }
    h1, h2 {
        color: #1f2937; /* Darker gray for headings */
        margin-bottom: 15px;
        font-weight: 600;
    }
    /* General input, select, button styling */
    input, select, button {
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #d1d5db; /* Light gray border */
        border-radius: 8px; /* Rounded corners */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Subtle shadow */
    }
    button {
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s, transform 0.2s;
    }
    button:hover {
        transform: translateY(-1px);
    }

    /* Form specific styling */
    .form-inline {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-bottom: 20px;
    }
    .form-inline > * {
        flex: 1 1 150px; /* Adjust flex basis for better responsiveness */
    }

    /* Button specific colors */
    .btn-danger { background-color: #ef4444; color: white; border: none; } /* Red */
    .btn-warning { background-color: #f59e0b; color: white; border: none; } /* Amber */
    .btn-primary { background-color: #3b82f6; color: white; border: none; } /* Blue */
    .btn-success { background-color: #10b981; color: white; border: none; } /* Green for export */
    .btn-danger:hover { background-color: #dc2626; }
    .btn-warning:hover { background-color: #d97706; }
    .btn-primary:hover { background-color: #2563eb; }
    .btn-success:hover { background-color: #059669; }

    /* Table styling */
    table {
        width: 100%;
        border-collapse: separate; /* Use separate to allow border-radius on cells */
        border-spacing: 0; /* Remove space between cell borders */
        margin-top: 20px;
        background-color: #ffffff;
        border-radius: 12px;
        overflow: hidden; /* Ensures rounded corners are applied */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    th, td {
        padding: 12px 15px;
        text-align: left; /* Align text left for better readability */
        border-bottom: 1px solid #e5e7eb; /* Light border between rows */
        font-size: 0.95rem;
    }
    th {
        background-color: #e5e7eb; /* Slightly darker header background */
        font-weight: 700;
        color: #374151; /* Darker text for headers */
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    tr:last-child td {
        border-bottom: none; /* No border for the last row */
    }
    tbody tr:nth-child(even) {
        background-color: #f9fafb; /* Alternate row background for readability */
    }
    tbody tr:hover {
        background-color: #eff6ff; /* Light blue on hover */
        transition: background-color 0.2s;
    }
    /* Specific styling for summary table totals */
    #summaryTable tr.total-auc, #summaryTable tr.total-group, #summaryTable tr.total-subgroup {
        font-weight: 700;
    }
    #summaryTable tr.total-auc {
        background-color: #bfdbfe; /* Light blue */
        color: #1e40af; /* Dark blue text */
        border-top: 2px solid #60a5fa;
    }
    #summaryTable tr.total-group {
        background-color: #dbeafe; /* Lighter blue */
        color: #1c50a0; /* Slightly darker blue text */
        border-top: 1px solid #93c5fd;
    }
    #summaryTable tr.total-subgroup {
        background-color: #e0f2fe; /* Even lighter blue */
        color: #1a478a; /* Darker text for sub-totals */
    }

    /* Chart container styling */
    #progressChart, #grafica {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .form-inline {
            flex-direction: column;
            align-items: stretch;
        }
        .form-inline > * {
            flex: none; /* Remove flex basis on small screens */
            width: 100%; /* Make elements take full width */
            margin-bottom: 10px; /* Add space between stacked elements */
        }
        table, thead, tbody, th, td, tr {
            display: block; /* Make table elements behave like blocks */
        }
        thead tr {
            position: absolute;
            top: -9999px; /* Hide table headers visually */
            left: -9999px;
        }
        tr {
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        td {
            border: none;
            position: relative;
            padding-left: 50%; /* Make space for the pseudo-element label */
            text-align: right;
            border-bottom: 1px solid #eee; /* Light line between cells in stacked rows */
        }
        td:last-child {
            border-bottom: none;
        }
        td:before {
            content: attr(data-label); /* Use data-label for content */
            position: absolute;
            left: 0;
            width: 45%;
            padding-left: 10px;
            font-weight: bold;
            text-align: left;
            white-space: nowrap; /* Prevent label from wrapping */
            color: #4a5568;
        }
        /* Specific data-labels for tables for mobile view */
        #tablaAUCs td:nth-of-type(1):before { content: "Nombre AUC:"; }
        #tablaAUCs td:nth-of-type(2):before { content: "Código AUC:"; }
        #tablaAUCs td:nth-of-type(3):before { content: "Acciones:"; }

        #tablaPresupuestos td:nth-of-type(1):before { content: "AUC:"; }
        #tablaPresupuestos td:nth-of-type(2):before { content: "Grupo:"; }
        #tablaPresupuestos td:nth-of-type(3):before { content: "Subgrupo:"; }
        #tablaPresupuestos td:nth-of-type(4):before { content: "Presupuesto MXN:"; }
        #tablaPresupuestos td:nth-of-type(5):before { content: "Gasto Acumulado:"; }
        #tablaPresupuestos td:nth-of-type(6):before { content: "Restante:"; }
        #tablaPresupuestos td:nth-of-type(7):before { content: "% Usado:"; }
        #tablaPresupuestos td:nth-of-type(8):before { content: "Acciones:"; }

        #ordersTable td:nth-of-type(1):before { content: "AUC:"; }
        #ordersTable td:nth-of-type(2):before { content: "Fecha:"; }
        #ordersTable td:nth-of-type(3):before { content: "# Carrito:"; }
        #ordersTable td:nth-of-type(4):before { content: "Orden Compra:"; }
        #ordersTable td:nth-of-type(5):before { content: "Grupo:"; }
        #ordersTable td:nth-of-type(6):before { content: "Subgrupo:"; }
        #ordersTable td:nth-of-type(7):before { content: "Monto MXN:"; }
        #ordersTable td:nth-of-type(8):before { content: "Monto EUR:"; }
        #ordersTable td:nth-of-type(9):before { content: "Comentarios:"; }
        #ordersTable td:nth-of-type(10):before { content: "Contratista:"; }
        #ordersTable td:nth-of-type(11):before { content: "Acciones:"; }

        #summaryTable td:nth-of-type(1):before { content: "AUC / Grupo / Subgrupo:"; }
        #summaryTable td:nth-of-type(2):before { content: "Presupuesto (MXN):"; }
        #summaryTable td:nth-of-type(3):before { content: "Presupuesto (EUR):"; }
        #summaryTable td:nth-of-type(4):before { content: "Gasto Real (MXN):"; }
        #summaryTable td:nth-of-type(5):before { content: "Gasto Real (EUR):"; }
        #summaryTable td:nth-of-type(6):before { content: "Restante (MXN):"; }
        #summaryTable td:nth-of-type(7):before { content: "Restante (EUR):"; }
        #summaryTable td:nth-of-type(8):before { content: "Avance (%):"; }
    }
</style>
</head>
<body>

<h1>Project Budget Monitoring</h1>

<div class="bg-white p-6 rounded-xl shadow-md mb-6">
    <div class="flex flex-wrap items-center gap-4">
        <label for="mesActual" class="font-semibold">Current Project Month:</label>
        <input type="number" id="mesActual" value="1" min="1" max="24" class="flex-1 min-w-0">
        <label for="duracionProyecto" class="font-semibold">Total Duration (months):</label>
        <input type="number" id="duracionProyecto" value="12" min="1" max="60" class="flex-1 min-w-0">
        <button onclick="calcularForecast()" class="btn-primary">Calculate Forecast</button>
    </div>
    <div id="resultadoForecast" class="mt-4 font-bold text-lg text-center"></div>
</div>

<h2>Register New AUC (Budget Package)</h2>
<form id="aucForm" class="form-inline">
    <input type="text" id="aucNombre" placeholder="AUC Name" required />
    <input type="text" id="aucCodigo" placeholder="AUC Code (Unique)" required />
    <button type="submit" class="btn-primary">Add AUC</button>
</form>

<h2>Registered AUCs</h2>
<table id="tablaAUCs">
    <thead>
        <tr>
            <th>AUC Name</th>
            <th>AUC Code</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="bg-white p-6 rounded-xl shadow-md my-6">
    <h2 class="mt-0">Select Active AUC</h2>
    <select id="activeAUCSelect" class="w-full" onchange="updateFormsAndCharts()">
        <option value="">Select an AUC to manage budgets/orders</option>
    </select>
</div>

<h2>Register Purchase Order</h2>
<form id="orderForm" class="form-inline">
  <input type="hidden" id="editOrderId" value="" /> <input type="hidden" id="orderAucCode" /> <input type="date" id="fecha" required />
  <input type="text" id="numCarrito" placeholder="Cart #" required />
  <input type="text" id="ordenCompra" placeholder="Purchase Order" required />
  <select id="grupo" required></select>
  <select id="subgrupo" required></select>
  <input type="number" id="montoMXN" placeholder="Amount MXN" min="0" step="0.01" required />
  <input type="text" id="comentarios" placeholder="Comments" />
  <input type="text" id="contratista" placeholder="Contractor" />
  <button type="submit" class="btn-primary">Save</button>
  <button type="button" id="cancelEditBtn" style="display:none;" class="btn-warning">Cancel Edit</button>
</form>

<h2>Register Budgets</h2>
<form id="formPresupuesto" class="form-inline">
  <input type="hidden" id="budgetAucCode" /> <label for="grupoPresupuesto" class="font-semibold">Group:</label>
  <select id="grupoPresupuesto" required></select>
  <label for="subgrupoPresupuesto" class="font-semibold">Subgroup:</label>
  <input type="text" id="subgrupoPresupuesto" required>
  <label for="montoPresupuesto" class="font-semibold">Budget Amount MXN:</label>
  <input type="number" id="montoPresupuesto" step="0.01" required> <button type="submit" class="btn-primary">Add Budget</button>
</form>

<table id="tablaPresupuestos">
  <thead>
    <tr>
      <th>AUC</th>
      <th>Group</th>
      <th>Subgroup</th>
      <th>Budget MXN</th>
      <th>Accumulated Expense</th>
      <th>Remaining</th>
      <th>% Used</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Registered Orders</h2>
<table id="ordersTable">
  <thead>
    <tr>
      <th>AUC</th>
      <th>Date</th>
      <th>Cart #</th>
      <th>Purchase Order</th>
      <th>Group</th>
      <th>Subgroup</th>
      <th>Amount MXN</th>
      <th>Amount EUR</th>
      <th>Comments</th>
      <th>Contratista</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Budget Summary</h2>
<table id="summaryTable">
  <thead>
    <tr>
      <th>AUC / Group / Subgroup</th>
      <th>Budget (MXN)</th>
      <th>Budget (EUR)</th>
      <th>Actual Expense (MXN)</th>
      <th>Actual Expense (EUR)</th>
      <th>Remaining (MXN)</th>
      <th>Remaining (EUR)</th>
      <th>Progress (%)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="mt-8 flex justify-end gap-4">
    <button onclick="exportData('presupuestos')" class="btn-success">Export Budgets to Excel</button>
    <button onclick="exportData('orders')" class="btn-success">Export Orders to Excel</button>
    <button onclick="exportData('summary')" class="btn-success">Export Summary to Excel</button>
</div>


<h2>Budget Progress by Group (%)</h2>
<canvas id="progressChart" class="mt-6"></canvas>

<h2>Budget vs. Expense Comparison</h2>
<h3 class="mt-4 mb-2">Filter by AUC / Group / Subgroup</h3>
<div class="flex flex-wrap gap-4 mb-4">
    <select id="filtroAUC" class="flex-1 min-w-0" onchange="handleFilterChange(event)"></select>
    <select id="filtroGrupo" class="flex-1 min-w-0" onchange="handleFilterChange(event)"></select>
    <select id="filtroSubgrupo" class="flex-1 min-w-0" onchange="handleFilterChange(event)"></select>
</div>
<canvas id="grafica"></canvas>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // Your web app's Firebase configuration
  // Replace these with your actual configuration from Firebase Console
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "https://budgettrackingbmm-default-rtdb.firebaseio.com/", // This is the URL you provided
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Reference to your data in Firebase
  const aucsRef = database.ref('aucs');
  const presupuestosRef = database.ref('presupuestos');
  const ordersRef = database.ref('orders');
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  // Global exchange rate
  const tasaMXNaEUR = 21.25;

  // Data storage: AUCs, Budgets (linked to AUC), Orders (linked to AUC and Budget)
  // These arrays will now be populated by Firebase listeners
  let aucs = [];
  let presupuestos = [];
  let orders = [];

  // Global variable for currently selected AUC
  let activeAUC = null;

  // DOM elements
  const aucForm = document.getElementById('aucForm');
  const tablaAUCsBody = document.querySelector('#tablaAUCs tbody');
  const activeAUCSelect = document.getElementById('activeAUCSelect');

  const orderForm = document.getElementById('orderForm');
  const orderAucCodeInput = document.getElementById('orderAucCode');
  const fechaInput = document.getElementById('fecha');
  const numCarritoInput = document.getElementById('numCarrito');
  const ordenCompraInput = document.getElementById('ordenCompra');
  const grupoSelect = document.getElementById('grupo');
  const subgrupoSelect = document.getElementById('subgrupo');
  const montoMXNInput = document.getElementById('montoMXN');
  const comentariosInput = document.getElementById('comentarios');
  const contratistaInput = document.getElementById('contratista');
  const editOrderIdInput = document.getElementById('editOrderId'); // Changed from editIndexInput
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const ordersTableBody = document.querySelector('#ordersTable tbody');

  const formPresupuesto = document.getElementById("formPresupuesto");
  const budgetAucCodeInput = document.getElementById('budgetAucCode');
  const grupoPresupuestoSelect = document.getElementById("grupoPresupuesto");
  const subgrupoPresupuestoInput = document.getElementById("subgrupoPresupuesto");
  const montoPresupuestoInput = document.getElementById("montoPresupuesto");
  const tablaPresupuestosBody = document.querySelector("#tablaPresupuestos tbody");

  const summaryTableBody = document.querySelector('#summaryTable tbody');
  const filtroAUCSelect = document.getElementById("filtroAUC");
  const filtroGrupoSelect = document.getElementById("filtroGrupo");
  const filtroSubgrupoSelect = document.getElementById("filtroSubgrupo");

  // Chart.js instances
  let progressChartInstance = null;
  let lineChartInstance = null;

  // --- Firebase Data Listeners ---
  aucsRef.on('value', (snapshot) => {
    aucs = [];
    snapshot.forEach((childSnapshot) => {
      aucs.push({ ...childSnapshot.val(), id: childSnapshot.key }); // Store Firebase key as 'id'
    });
    initializeApp(); // Re-initialize/re-render everything that depends on AUCs
  });

  presupuestosRef.on('value', (snapshot) => {
    presupuestos = [];
    snapshot.forEach((childSnapshot) => {
      presupuestos.push({ ...childSnapshot.val(), id: childSnapshot.key });
    });
    // These functions will be called by initializeApp() or updateFormsAndCharts()
    // No need to call them directly here as they rely on AUCs and overall state
    initializeApp();
  });

  ordersRef.on('value', (snapshot) => {
    orders = [];
    snapshot.forEach((childSnapshot) => {
      orders.push({ ...childSnapshot.val(), id: childSnapshot.key });
    });
    // These functions will be called by initializeApp() or updateFormsAndCharts()
    initializeApp();
  });


  // --- General UI and Data Management Functions ---

  // Custom message box function (replaces alert())
  function displayMessage(message, type = "info") {
    let messageBox = document.getElementById("messageBox");
    if (!messageBox) {
      messageBox = document.createElement("div");
      messageBox.id = "messageBox";
      messageBox.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: bold;
                color: white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                opacity: 0;
                transform: translateY(-20px);
                transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            `;
      document.body.appendChild(messageBox);
    }

    messageBox.textContent = message;
    messageBox.style.backgroundColor = ""; // Reset background
    if (type === "success") {
      messageBox.style.backgroundColor = "#28a745";
    } else if (type === "error") {
      messageBox.style.backgroundColor = "#dc3545";
    } else if (type === "warning") {
      messageBox.style.backgroundColor = "#ffc107";
      messageBox.style.color = "#333";
    } else {
      messageBox.style.backgroundColor = "#007bff";
    }

    messageBox.style.opacity = 1;
    messageBox.style.transform = "translateY(0)";

    setTimeout(() => {
      messageBox.style.opacity = 0;
      messageBox.style.transform = "translateY(-20px)";
    }, 3000);
  }

  // --- AUC Management ---

  aucForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const nombre = document.getElementById('aucNombre').value.trim();
    const codigo = document.getElementById('aucCodigo').value.trim();

    if (!nombre || !codigo) {
      displayMessage("Please enter both AUC Name and AUC Code.", "error");
      return;
    }
    if (aucs.some(a => a.codigo === codigo)) {
      displayMessage("An AUC with this code already exists.", "warning");
      return;
    }

    aucsRef.push({ nombre, codigo })
      .then(() => {
        displayMessage("AUC added successfully!", "success");
        this.reset();
      })
      .catch((error) => displayMessage("Error adding AUC: " + error.message, "error"));
  });

  function renderAUCs() {
    tablaAUCsBody.innerHTML = "";
    if (aucs.length === 0) {
      tablaAUCsBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">No AUCs registered yet.</td></tr>';
      return;
    }
    aucs.forEach((auc) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td data-label="AUC Name">${auc.nombre}</td>
        <td data-label="AUC Code">${auc.codigo}</td>
        <td data-label="Actions">
          <button onclick="deleteAUC('${auc.id}')" class="btn-danger">Delete</button>
        </td>
      `;
      tablaAUCsBody.appendChild(row);
    });
  }

  window.deleteAUC = function(aucId) {
    const aucToDelete = aucs.find(a => a.id === aucId);
    if (!aucToDelete) return;

    if (confirm(`Are you sure you want to delete AUC "${aucToDelete.nombre}" (${aucToDelete.codigo})? This will also delete all associated budgets and orders.`)) {
      // Delete associated budgets
      presupuestos.filter(p => p.auc === aucToDelete.codigo).forEach(p => {
        presupuestosRef.child(p.id).remove();
      });
      // Delete associated orders
      orders.filter(o => o.auc === aucToDelete.codigo).forEach(o => {
        ordersRef.child(o.id).remove();
      });

      // Delete the AUC itself
      aucsRef.child(aucId).remove()
        .then(() => {
          if (activeAUC && activeAUC.id === aucId) {
            activeAUC = null; // Clear active AUC if deleted
          }
          displayMessage("AUC and associated data deleted.", "success");
        })
        .catch((error) => displayMessage("Error deleting AUC: " + error.message, "error"));
    }
  };

  function initAUCSelects() {
    // Populate the active AUC selector
    activeAUCSelect.innerHTML = '<option value="">Select an AUC to manage budgets/orders</option>' +
      aucs.map(a => `<option value="${a.id}" ${activeAUC && activeAUC.id === a.id ? 'selected' : ''}>${a.nombre} (${a.codigo})</option>`).join('');
      // Use AUC ID as value for activeAUCSelect

    // Populate chart filter AUC selector
    filtroAUCSelect.innerHTML = '<option value="todos">All AUCs</option>' +
      aucs.map(a => `<option value="${a.codigo}">${a.nombre} (${a.codigo})</option>`).join('');
  }

  function updateFormsAndCharts() {
    const selectedId = activeAUCSelect.value;
    activeAUC = aucs.find(a => a.id === selectedId) || null; // Find by ID

    // Enable/disable forms based on active AUC
    const forms = [orderForm, formPresupuesto];
    forms.forEach(form => {
      form.style.opacity = activeAUC ? '1' : '0.5';
      Array.from(form.elements).forEach(element => {
        if (element.type !== 'hidden') {
          element.disabled = !activeAUC;
        }
      });
    });

    // Set hidden AUC code inputs for forms
    orderAucCodeInput.value = activeAUC ? activeAUC.codigo : '';
    budgetAucCodeInput.value = activeAUC ? activeAUC.codigo : '';

    // Update dropdowns (Grupo/Subgrupo) in forms and charts
    updateGrupoSubgrupoSelects();
    renderPresupuestos();
    renderOrdersTable();
    renderSummaryTable();
    updateProgressChart();
    cargarFiltros(); // Re-load filters with current AUC context
    generarGrafica();
    calcularForecast();
  }

  function updateGrupoSubgrupoSelects() {
    // Update Group select for order form
    let availableGroups = [];
    if (activeAUC) {
      availableGroups = [...new Set(presupuestos
        .filter(p => p.auc === activeAUC.codigo)
        .map(p => p.grupo))].sort();
    }
    grupoSelect.innerHTML = '<option value="">Select Group</option>' + availableGroups.map(g => `<option value="${g}">${g}</option>`).join('');
    subgrupoSelect.innerHTML = '<option value="">Select Subgroup</option>'; // Clear subgroup on group change

    // Update Group select for budget form
    let availableBudgetGroups = [];
    if (activeAUC) {
        // Get groups already defined for the active AUC
        availableBudgetGroups = [...new Set(presupuestos
            .filter(p => p.auc === activeAUC.codigo)
            .map(p => p.grupo))].sort();
    }
    
    // Add some common default groups if no AUC selected or no groups yet
    const commonGroups = ["Equipment", "Mechanical", "Electrical", "Automation", "CSA", "Personnel", "Engineering", "HVAC", "Black Utilities", "Cubierta", "MEP"];
    
    // Combine existing groups with common groups without duplicates
    const finalBudgetGroups = [...new Set([...availableBudgetGroups, ...commonGroups])].sort();

    grupoPresupuestoSelect.innerHTML = '<option value="">Select Group</option>' + finalBudgetGroups.map(g => `<option value="${g}">${g}</option>`).join('');
  }

  // Dynamically populate subgroups in order form based on selected group and AUC
  grupoSelect.addEventListener('change', () => {
    const selectedGroup = grupoSelect.value;
    let availableSubgroups = [];
    if (activeAUC && selectedGroup) {
      availableSubgroups = [...new Set(presupuestos
        .filter(p => p.auc === activeAUC.codigo && p.grupo === selectedGroup)
        .map(p => p.subgrupo))].sort();
    }
    subgrupoSelect.innerHTML = '<option value="">Select Subgroup</option>' + availableSubgroups.map(sg => `<option value="${sg}">${sg}</option>`).join('');
  });

  // --- Budget Management ---

  formPresupuesto.addEventListener("submit", function(e) {
    e.preventDefault();
    if (!activeAUC) {
      displayMessage("Please select an active AUC first.", "warning");
      return;
    }

    const auc = budgetAucCodeInput.value;
    const grupo = grupoPresupuestoSelect.value;
    const subgrupo = subgrupoPresupuestoInput.value.trim();
    const monto = parseFloat(montoPresupuestoInput.value);

    if (!grupo || !subgrupo || isNaN(monto) || monto <= 0) {
      displayMessage("Please complete all budget fields and ensure the amount is a positive number.", "error");
      return;
    }

    const existente = presupuestos.find(p => p.auc === auc && p.grupo === grupo && p.subgrupo === subgrupo);
    if (existente) {
      displayMessage("This budget already exists for this AUC/Group/Subgroup. Edit it if you wish to modify it.", "warning");
      return;
    }

    presupuestosRef.push({ auc, grupo, subgrupo, monto })
      .then(() => {
        displayMessage("Budget added successfully!", "success");
        this.reset();
      })
      .catch((error) => displayMessage("Error adding budget: " + error.message, "error"));
  });

  function renderPresupuestos() {
    tablaPresupuestosBody.innerHTML = "";
    const filteredPresupuestos = activeAUC ? presupuestos.filter(p => p.auc === activeAUC.codigo) : [];

    if (filteredPresupuestos.length === 0) {
        tablaPresupuestosBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500">${activeAUC ? `No budgets registered for AUC: ${activeAUC.nombre} (${activeAUC.codigo}).` : 'Please select an AUC or register new budgets.'}</td></tr>`;
        return;
    }

    filteredPresupuestos.forEach((p) => {
      const gasto = calcularGastoPorSubgrupo(p.auc, p.grupo, p.subgrupo);
      const restante = p.monto - gasto;
      const porcentaje = p.monto > 0 ? ((gasto / p.monto) * 100).toFixed(1) : 0;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td data-label="AUC">${p.auc}</td>
        <td data-label="Group">${p.grupo}</td>
        <td data-label="Subgroup">${p.subgrupo}</td>
        <td data-label="Budget MXN">$${p.monto.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td data-label="Accumulated Expense">$${gasto.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td data-label="Remaining">$${restante.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td data-label="% Used">${porcentaje}%</td>
        <td data-label="Actions">
          <button onclick="editarPresupuesto('${p.id}')" class="btn-warning">Edit</button>
          <button onclick="eliminarPresupuesto('${p.id}')" class="btn-danger">Delete</button>
        </td>
      `;
      tablaPresupuestosBody.appendChild(row);
    });
  }

  window.editarPresupuesto = function(budgetId) {
    const p = presupuestos.find(b => b.id === budgetId);
    if (!p) return;

    let nuevoMonto = prompt(`Edit amount for AUC: ${p.auc}, Group: ${p.grupo}, Subgroup: ${p.subgrupo}:`, p.monto);
    if (nuevoMonto !== null) {
      nuevoMonto = parseFloat(nuevoMonto);
      if (!isNaN(nuevoMonto) && nuevoMonto >= 0) {
        presupuestosRef.child(budgetId).update({ monto: nuevoMonto })
          .then(() => displayMessage("Budget updated successfully!", "success"))
          .catch((error) => displayMessage("Error updating budget: " + error.message, "error"));
      } else {
        displayMessage("Invalid amount. Please enter a positive number.", "error");
      }
    }
  };

  window.eliminarPresupuesto = function(budgetId) {
    const p = presupuestos.find(b => b.id === budgetId);
    if (!p) return;

    if (confirm(`Are you sure you want to delete budget for AUC: ${p.auc}, Group: ${p.grupo}, Subgroup: ${p.subgrupo}? This will not delete associated orders.`)) {
      presupuestosRef.child(budgetId).remove()
        .then(() => displayMessage("Budget deleted successfully!", "success"))
        .catch((error) => displayMessage("Error deleting budget: " + error.message, "error"));
    }
  };

  // --- Purchase Order Management ---

  orderForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!activeAUC) {
      displayMessage("Please select an active AUC first to register orders.", "warning");
      return;
    }
    const auc = orderAucCodeInput.value;
    const fecha = fechaInput.value;
    const numCarrito = numCarritoInput.value.trim();
    const ordenCompra = ordenCompraInput.value.trim();
    const grupo = grupoSelect.value;
    const subgrupo = subgrupoSelect.value;
    const montoMXN = parseFloat(montoMXNInput.value);
    const comentarios = comentariosInput.value.trim();
    const contratista = contratistaInput.value.trim();

    if (!fecha || !numCarrito || !ordenCompra || !grupo || !subgrupo || isNaN(montoMXN) || montoMXN <= 0) {
      displayMessage('Please complete all required fields and ensure the amount is a positive number.', 'error');
      return;
    }

    // Validate that budget exists for this AUC/Group/Subgroup
    const existingBudget = presupuestos.find(p => p.auc === auc && p.grupo === grupo && p.subgrupo === subgrupo);
    if (!existingBudget) {
      displayMessage(`No budget found for AUC: ${auc}, Group: ${grupo}, Subgroup: ${subgrupo}. Please register a budget first.`, "error");
      return;
    }

    const orderData = { auc, fecha, numCarrito, ordenCompra, grupo, subgrupo, montoMXN, comentarios, contratista };
    const editOrderId = editOrderIdInput.value;

    if (editOrderId === "") { // No ID means new order
      ordersRef.push(orderData)
        .then(() => {
          displayMessage("Order added successfully!", "success");
          resetOrderForm();
        })
        .catch((error) => displayMessage("Error adding order: " + error.message, "error"));
    } else { // Has an ID, so update existing
      ordersRef.child(editOrderId).set(orderData)
        .then(() => {
          displayMessage("Order updated successfully!", "success");
          resetOrderForm();
        })
        .catch((error) => displayMessage("Error updating order: " + error.message, "error"));
    }
  });

  function resetOrderForm() {
    orderForm.reset();
    editOrderIdInput.value = ""; // Clear edit ID
    cancelEditBtn.style.display = 'none';
    orderForm.querySelector('button[type="submit"]').textContent = 'Save';
    grupoSelect.innerHTML = '<option value="">Select Group</option>'; // Reset groups
    subgrupoSelect.innerHTML = '<option value="">Select Subgroup</option>'; // Reset subgroups
    updateGrupoSubgrupoSelects(); // Re-populate based on active AUC
  }

  function renderOrdersTable() {
    ordersTableBody.innerHTML = '';
    const filteredOrders = activeAUC ? orders.filter(o => o.auc === activeAUC.codigo) : [];

    if (filteredOrders.length === 0) {
      ordersTableBody.innerHTML = `<tr><td colspan="11" class="text-center text-gray-500">${activeAUC ? `No orders registered for AUC: ${activeAUC.nombre} (${activeAUC.codigo}).` : 'Please select an AUC or register new orders.'}</td></tr>`;
      return;
    }

    filteredOrders.forEach((order) => {
      const montoEUR = (order.montoMXN / tasaMXNaEUR).toFixed(2);
      ordersTableBody.innerHTML += `
        <tr>
          <td data-label="AUC">${order.auc}</td>
          <td data-label="Date">${order.fecha}</td>
          <td data-label="Cart #">${order.numCarrito}</td>
          <td data-label="Purchase Order">${order.ordenCompra}</td>
          <td data-label="Group">${order.grupo}</td>
          <td data-label="Subgroup">${order.subgrupo}</td>
          <td data-label="Amount MXN">$${order.montoMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td data-label="Amount EUR">€${parseFloat(montoEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td data-label="Comments">${order.comentarios}</td>
          <td data-label="Contratista">${order.contratista}</td>
          <td data-label="Actions">
            <button onclick="editOrder('${order.id}')" class="btn-warning">Edit</button>
            <button onclick="deleteOrder('${order.id}')" class="btn-danger">Delete</button>
          </td>
        </tr>
      `;
    });
  }

  window.editOrder = function(orderId) {
    const orderToEdit = orders.find(o => o.id === orderId);
    if (!orderToEdit) return;

    // Populate form fields
    fechaInput.value = orderToEdit.fecha;
    numCarritoInput.value = orderToEdit.numCarrito;
    ordenCompraInput.value = orderToEdit.ordenCompra;
    montoMXNInput.value = orderToEdit.montoMXN;
    comentariosInput.value = orderToEdit.comentarios;
    contratistaInput.value = orderToEdit.contratista;

    // Set group and then populate subgroup
    grupoSelect.value = orderToEdit.grupo;
    // Manually trigger change to populate subgroups for the selected group
    const event = new Event('change');
    grupoSelect.dispatchEvent(event);
    subgrupoSelect.value = orderToEdit.subgrupo;

    editOrderIdInput.value = orderToEdit.id; // Store Firebase ID for update
    orderForm.querySelector('button[type="submit"]').textContent = 'Update';
    cancelEditBtn.style.display = 'inline-block';
  };

  cancelEditBtn.addEventListener('click', resetOrderForm);

  window.deleteOrder = function(orderId) {
    if (confirm("Are you sure you want to delete this order?")) {
      ordersRef.child(orderId).remove()
        .then(() => displayMessage("Order deleted successfully!", "success"))
        .catch((error) => displayMessage("Error deleting order: " + error.message, "error"));
    }
  };

  // --- Calculations and Summaries ---

  function calcularGastoPorSubgrupo(aucCode, grupoName, subgrupoName) {
    return orders
      .filter(o => o.auc === aucCode && o.grupo === grupoName && o.subgrupo === subgrupoName)
      .reduce((sum, order) => sum + order.montoMXN, 0);
  }

  function renderSummaryTable() {
    summaryTableBody.innerHTML = "";
    const summaryData = {}; // Stores aggregated data for summary table

    // Filter budgets for the active AUC only
    const budgetsForActiveAUC = activeAUC ? presupuestos.filter(p => p.auc === activeAUC.codigo) : [];

    // Group budgets by AUC, then by Group, then by Subgroup
    budgetsForActiveAUC.forEach(budget => {
      if (!summaryData[budget.auc]) {
        summaryData[budget.auc] = { groups: {}, totalBudgetMXN: 0, totalActualMXN: 0 };
      }
      if (!summaryData[budget.auc].groups[budget.grupo]) {
        summaryData[budget.auc].groups[budget.grupo] = { subgroups: {}, totalBudgetMXN: 0, totalActualMXN: 0 };
      }
      summaryData[budget.auc].groups[budget.grupo].subgroups[budget.subgrupo] = {
        budgetMXN: budget.monto,
        actualMXN: calcularGastoPorSubgrupo(budget.auc, budget.grupo, budget.subgrupo)
      };

      summaryData[budget.auc].totalBudgetMXN += budget.monto;
      summaryData[budget.auc].totalActualMXN += calcularGastoPorSubgrupo(budget.auc, budget.grupo, budget.subgrupo);

      summaryData[budget.auc].groups[budget.grupo].totalBudgetMXN += budget.monto;
      summaryData[budget.auc].groups[budget.grupo].totalActualMXN += calcularGastoPorSubgrupo(budget.auc, budget.grupo, budget.subgrupo);
    });

    // Render the summary table
    for (const aucCode in summaryData) {
      const aucName = aucs.find(a => a.codigo === aucCode)?.nombre || aucCode;

      // Render AUC total row
      const aucTotalRow = document.createElement('tr');
      aucTotalRow.className = 'total-auc';
      const aucRemainingMXN = summaryData[aucCode].totalBudgetMXN - summaryData[aucCode].totalActualMXN;
      const aucRemainingEUR = (aucRemainingMXN / tasaMXNaEUR).toFixed(2);
      const aucProgress = summaryData[aucCode].totalBudgetMXN > 0 ? ((summaryData[aucCode].totalActualMXN / summaryData[aucCode].totalBudgetMXN) * 100).toFixed(1) : 0;
      aucTotalRow.innerHTML = `
        <td data-label="AUC / Group / Subgroup"><strong>Total for ${aucName} (${aucCode})</strong></td>
        <td data-label="Budget (MXN)">$${summaryData[aucCode].totalBudgetMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td data-label="Budget (EUR)">€${(summaryData[aucCode].totalBudgetMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td data-label="Actual Expense (MXN)">$${summaryData[aucCode].totalActualMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td data-label="Actual Expense (EUR)">€${(summaryData[aucCode].totalActualMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td data-label="Remaining (MXN)">$${aucRemainingMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td data-label="Remaining (EUR)">€${parseFloat(aucRemainingEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td data-label="Progress (%)">${aucProgress}%</td>
      `;
      summaryTableBody.appendChild(aucTotalRow);

      for (const groupName in summaryData[aucCode].groups) {
        // Render Group total row
        const groupTotalRow = document.createElement('tr');
        groupTotalRow.className = 'total-group';
        const groupRemainingMXN = summaryData[aucCode].groups[groupName].totalBudgetMXN - summaryData[aucCode].groups[groupName].totalActualMXN;
        const groupRemainingEUR = (groupRemainingMXN / tasaMXNaEUR).toFixed(2);
        const groupProgress = summaryData[aucCode].groups[groupName].totalBudgetMXN > 0 ? ((summaryData[aucCode].groups[groupName].totalActualMXN / summaryData[aucCode].groups[groupName].totalBudgetMXN) * 100).toFixed(1) : 0;
        groupTotalRow.innerHTML = `
          <td data-label="AUC / Group / Subgroup">&nbsp;&nbsp;&nbsp;<strong>Total for ${groupName}</strong></td>
          <td data-label="Budget (MXN)">$${summaryData[aucCode].groups[groupName].totalBudgetMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td data-label="Budget (EUR)">€${(summaryData[aucCode].groups[groupName].totalBudgetMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td data-label="Actual Expense (MXN)">$${summaryData[aucCode].groups[groupName].totalActualMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td data-label="Actual Expense (EUR)">€${(summaryData[aucCode].groups[groupName].totalActualMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td data-label="Remaining (MXN)">$${groupRemainingMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td data-label="Remaining (EUR)">€${parseFloat(groupRemainingEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td data-label="Progress (%)">${groupProgress}%</td>
        `;
        summaryTableBody.appendChild(groupTotalRow);

        for (const subgroupName in summaryData[aucCode].groups[groupName].subgroups) {
          const subgroup = summaryData[aucCode].groups[groupName].subgroups[subgroupName];
          const remainingMXN = subgroup.budgetMXN - subgroup.actualMXN;
          const remainingEUR = (remainingMXN / tasaMXNaEUR).toFixed(2);
          const progress = subgroup.budgetMXN > 0 ? ((subgroup.actualMXN / subgroup.budgetMXN) * 100).toFixed(1) : 0;

          const subgroupRow = document.createElement('tr');
          subgroupRow.className = 'total-subgroup';
          subgroupRow.innerHTML = `
            <td data-label="AUC / Group / Subgroup">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${subgroupName}</td>
            <td data-label="Budget (MXN)">$${subgroup.budgetMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td data-label="Budget (EUR)">€${(subgroup.budgetMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td data-label="Actual Expense (MXN)">$${subgroup.actualMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td data-label="Actual Expense (EUR)">€${(subgroup.actualMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td data-label="Remaining (MXN)">$${remainingMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td data-label="Remaining (EUR)">€${parseFloat(remainingEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td data-label="Progress (%)">${progress}%</td>
          `;
          summaryTableBody.appendChild(subgroupRow);
        }
      }
    }

    if (Object.keys(summaryData).length === 0) {
      summaryTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500">${activeAUC ? `No summary data for AUC: ${activeAUC.nombre} (${activeAUC.codigo}).` : 'Please select an AUC or register new budgets/orders.'}</td></tr>`;
    }
  }


  function updateProgressChart() {
    if (progressChartInstance) {
      progressChartInstance.destroy();
    }

    const labels = [];
    const budgetData = [];
    const spentData = [];
    const backgroundColor = [];
    const borderColor = [];

    if (activeAUC) {
      const groupsInActiveAUC = [...new Set(presupuestos
        .filter(p => p.auc === activeAUC.codigo)
        .map(p => p.grupo))].sort();

      groupsInActiveAUC.forEach(group => {
        const totalBudgetForGroup = presupuestos
          .filter(p => p.auc === activeAUC.codigo && p.grupo === group)
          .reduce((sum, p) => sum + p.monto, 0);

        const totalSpentForGroup = orders
          .filter(o => o.auc === activeAUC.codigo && o.grupo === group)
          .reduce((sum, o) => sum + o.montoMXN, 0);

        labels.push(group);
        budgetData.push(totalBudgetForGroup);
        spentData.push(totalSpentForGroup);

        const progress = totalBudgetForGroup > 0 ? (totalSpentForGroup / totalBudgetForGroup) : 0;
        // Simple color logic based on progress
        if (progress > 0.9) {
          backgroundColor.push('rgba(255, 99, 132, 0.7)'); // Red
          borderColor.push('rgba(255, 99, 132, 1)');
        } else if (progress > 0.7) {
          backgroundColor.push('rgba(255, 206, 86, 0.7)'); // Yellow
          borderColor.push('rgba(255, 206, 86, 1)');
        } else {
          backgroundColor.push('rgba(75, 192, 192, 0.7)'); // Green
          borderColor.push('rgba(75, 192, 192, 1)');
        }
      });
    }

    const ctx = document.getElementById('progressChart').getContext('2d');
    progressChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Budget (MXN)',
          data: budgetData,
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }, {
          label: 'Spent (MXN)',
          data: spentData,
          backgroundColor: backgroundColor,
          borderColor: borderColor,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Amount (MXN)'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: activeAUC ? `Budget vs. Expense by Group for AUC: ${activeAUC.nombre} (${activeAUC.codigo})` : 'Budget vs. Expense by Group (Select an AUC)',
            font: {
              size: 16
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'MXN' }).format(context.parsed.y);
                }
                return label;
              }
            }
          }
        }
      }
    });
  }

  // --- Filtering and Graph (Budget vs. Expense) ---
  let chartData = {
    labels: [],
    datasets: [{
      label: 'Budget (MXN)',
      data: [],
      borderColor: 'rgb(75, 192, 192)',
      tension: 0.1
    }, {
      label: 'Expense (MXN)',
      data: [],
      borderColor: 'rgb(255, 99, 132)',
      tension: 0.1
    }]
  };

  const ctxGrafica = document.getElementById('grafica').getContext('2d');
  lineChartInstance = new Chart(ctxGrafica, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Amount (MXN)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Months'
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'Budget vs. Expense Over Time',
          font: {
            size: 16
          }
        },
        tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'MXN' }).format(context.parsed.y);
                }
                return label;
              }
            }
          }
      }
    }
  });


  function cargarFiltros() {
    // Populate Group and Subgroup filters based on selected AUC
    const selectedAUC = filtroAUCSelect.value === "todos" ? null : filtroAUCSelect.value;
    const filteredPresupuestosByAUC = selectedAUC ? presupuestos.filter(p => p.auc === selectedAUC) : presupuestos;

    const uniqueGroups = ["todos", ...new Set(filteredPresupuestosByAUC.map(p => p.grupo))].sort();
    filtroGrupoSelect.innerHTML = uniqueGroups.map(g => `<option value="${g}">${g}</option>`).join('');

    // Update subgroup filter based on selected group and AUC
    handleFilterChange(); // Call to update subgroups and generate graph initially
  }

  function handleFilterChange() {
    const selectedAUC = filtroAUCSelect.value === "todos" ? null : filtroAUCSelect.value;
    const selectedGroup = filtroGrupoSelect.value === "todos" ? null : filtroGrupoSelect.value;

    let filteredPresupuestosForSubgroupFilter = presupuestos;
    if (selectedAUC) {
      filteredPresupuestosForSubgroupFilter = filteredPresupuestosForSubgroupFilter.filter(p => p.auc === selectedAUC);
    }
    if (selectedGroup) {
      filteredPresupuestosForSubgroupFilter = filteredPresupuestosForSubgroupFilter.filter(p => p.grupo === selectedGroup);
    }

    const uniqueSubgroups = ["todos", ...new Set(filteredPresupuestosForSubgroupFilter.map(p => p.subgrupo))].sort();
    filtroSubgrupoSelect.innerHTML = uniqueSubgroups.map(sg => `<option value="${sg}">${sg}</option>`).join('');

    generarGrafica();
  }

  function generarGrafica() {
    const selectedAUC = filtroAUCSelect.value === "todos" ? null : filtroAUCSelect.value;
    const selectedGroup = filtroGrupoSelect.value === "todos" ? null : filtroGrupoSelect.value;
    const selectedSubgroup = filtroSubgrupoSelect.value === "todos" ? null : filtroSubgrupoSelect.value;

    let filteredPresupuestos = presupuestos;
    let filteredOrders = orders;

    if (selectedAUC) {
      filteredPresupuestos = filteredPresupuestos.filter(p => p.auc === selectedAUC);
      filteredOrders = filteredOrders.filter(o => o.auc === selectedAUC);
    }
    if (selectedGroup) {
      filteredPresupuestos = filteredPresupuestos.filter(p => p.grupo === selectedGroup);
      filteredOrders = filteredOrders.filter(o => o.grupo === selectedGroup);
    }
    if (selectedSubgroup) {
      filteredPresupuestos = filteredPresupuestos.filter(p => p.subgrupo === selectedSubgroup);
      filteredOrders = filteredOrders.filter(o => o.subgrupo === selectedSubgroup);
    }

    // Determine the relevant months based on actual order dates
    const allDates = filteredOrders.map(o => new Date(o.fecha));
    const minDate = allDates.length > 0 ? new Date(Math.min(...allDates)) : new Date();
    const maxDate = allDates.length > 0 ? new Date(Math.max(...allDates)) : new Date();

    const monthLabels = [];
    const monthlyBudget = [];
    const monthlyExpense = [];

    const currentMonth = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
    const endMonth = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);

    while (currentMonth <= endMonth) {
        const yearMonth = `${currentMonth.getFullYear()}-${(currentMonth.getMonth() + 1).toString().padStart(2, '0')}`;
        monthLabels.push(yearMonth);

        // Calculate total budget for this month (cumulative sum of budgets that started before/on this month)
        // For simplicity, assuming budgets are set and apply for the entire duration.
        // A more complex model might distribute budget monthly. Here, we'll sum relevant budgets.
        const totalBudget = filteredPresupuestos.reduce((sum, p) => sum + p.monto, 0);
        monthlyBudget.push(totalBudget);

        // Calculate accumulated expenses up to this month
        const expensesUpToMonth = filteredOrders
            .filter(o => new Date(o.fecha).getFullYear() < currentMonth.getFullYear() || 
                         (new Date(o.fecha).getFullYear() === currentMonth.getFullYear() && new Date(o.fecha).getMonth() <= currentMonth.getMonth()))
            .reduce((sum, o) => sum + o.montoMXN, 0);
        monthlyExpense.push(expensesUpToMonth);

        currentMonth.setMonth(currentMonth.getMonth() + 1);
    }

    // If no orders, but there are budgets, ensure at least one data point for budgets
    if (monthLabels.length === 0 && filteredPresupuestos.length > 0) {
        const totalBudget = filteredPresupuestos.reduce((sum, p) => sum + p.monto, 0);
        const today = new Date();
        const yearMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
        monthLabels.push(yearMonth);
        monthlyBudget.push(totalBudget);
        monthlyExpense.push(0); // No expenses if no orders
    }
    
    // Update chart data
    lineChartInstance.data.labels = monthLabels;
    lineChartInstance.data.datasets[0].data = monthlyBudget;
    lineChartInstance.data.datasets[1].data = monthlyExpense;
    lineChartInstance.update();
  }


  // --- Forecast Calculation ---
  function calcularForecast() {
    const mesActual = parseInt(document.getElementById('mesActual').value);
    const duracionProyecto = parseInt(document.getElementById('duracionProyecto').value);
    const resultadoForecastDiv = document.getElementById('resultadoForecast');

    if (isNaN(mesActual) || isNaN(duracionProyecto) || mesActual <= 0 || duracionProyecto <= 0 || mesActual > duracionProyecto) {
      resultadoForecastDiv.textContent = "Please enter valid current month and project duration.";
      resultadoForecastDiv.className = "mt-4 font-bold text-lg text-red-600 text-center";
      return;
    }

    const totalBudget = presupuestos.reduce((sum, p) => sum + p.monto, 0);
    const totalSpent = orders.reduce((sum, o) => sum + o.montoMXN, 0);

    if (totalBudget === 0) {
        resultadoForecastDiv.textContent = "No budgets registered. Cannot calculate forecast.";
        resultadoForecastDiv.className = "mt-4 font-bold text-lg text-yellow-600 text-center";
        return;
    }

    if (totalSpent === 0) {
        resultadoForecastDiv.textContent = "No expenses registered yet. Forecast will be equal to total budget: " + totalBudget.toLocaleString(undefined, {style:'currency', currency:'MXN'});
        resultadoForecastDiv.className = "mt-4 font-bold text-lg text-blue-600 text-center";
        return;
    }

    const averageMonthlyBurnRate = totalSpent / mesActual;
    const projectedTotalExpense = averageMonthlyBurnRate * duracionProyecto;
    const variance = totalBudget - projectedTotalExpense;

    let message = `
        <p><strong>Actual Spending (Current Month ${mesActual}):</strong> $${totalSpent.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</p>
        <p><strong>Average Monthly Burn Rate:</strong> $${averageMonthlyBurnRate.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} / month</p>
        <p><strong>Projected Total Expense (End of Month ${duracionProyecto}):</strong> $${projectedTotalExpense.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</p>
        <p><strong>Total Budget:</strong> $${totalBudget.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</p>
        <p><strong>Variance (Budget - Projected):</strong> $${variance.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</p>
    `;
    
    if (variance < 0) {
        message += `<p class="text-red-600"><strong>Warning: Projected expenses exceed total budget!</strong></p>`;
        resultadoForecastDiv.className = "mt-4 font-bold text-lg text-red-600 text-center";
    } else if (variance > 0 && totalBudget > 0 && (projectedTotalExpense / totalBudget) < 0.8) {
         message += `<p class="text-green-600"><strong>Good: Projected expenses are within budget.</strong></p>`;
         resultadoForecastDiv.className = "mt-4 font-bold text-lg text-green-600 text-center";
    } else {
        resultadoForecastDiv.className = "mt-4 font-bold text-lg text-blue-600 text-center";
    }

    resultadoForecastDiv.innerHTML = message;
  }


  // --- Export to Excel ---
  window.exportData = function(type) {
        const wb = XLSX.utils.book_new();
        let dataToExport = [];
        let sheetName = '';

        if (type === 'presupuestos') {
            dataToExport = presupuestos.map(p => {
                const gasto = calcularGastoPorSubgrupo(p.auc, p.grupo, p.subgrupo);
                const restante = p.monto - gasto;
                const porcentaje = p.monto > 0 ? ((gasto / p.monto) * 100).toFixed(1) : 0;
                return {
                    'AUC': p.auc,
                    'Grupo': p.grupo,
                    'Subgrupo': p.subgrupo,
                    'Presupuesto MXN': p.monto,
                    'Gasto Acumulado MXN': gasto,
                    'Restante MXN': restante,
                    '% Usado': porcentaje
                };
            });
            sheetName = 'Budgets';
        } else if (type === 'orders') {
            dataToExport = orders.map(o => ({
                'AUC': o.auc,
                'Fecha': o.fecha,
                'Num Carrito': o.numCarrito,
                'Orden Compra': o.ordenCompra,
                'Grupo': o.grupo,
                'Subgrupo': o.subgrupo,
                'Monto MXN': o.montoMXN,
                'Monto EUR': (o.montoMXN / tasaMXNaEUR).toFixed(2),
                'Comentarios': o.comentarios,
                'Contratista': o.contratista
            }));
            sheetName = 'Orders';
        } else if (type === 'summary') {
            const summaryRows = [];
            const summaryData = {};

            // Aggregate data similar to renderSummaryTable
            presupuestos.forEach(budget => {
                if (!summaryData[budget.auc]) {
                    summaryData[budget.auc] = { groups: {}, totalBudgetMXN: 0, totalActualMXN: 0 };
                }
                if (!summaryData[budget.auc].groups[budget.grupo]) {
                    summaryData[budget.auc].groups[budget.grupo] = { subgroups: {}, totalBudgetMXN: 0, totalActualMXN: 0 };
                }
                summaryData[budget.auc].groups[budget.grupo].subgroups[budget.subgrupo] = {
                    budgetMXN: budget.monto,
                    actualMXN: calcularGastoPorSubgrupo(budget.auc, budget.grupo, budget.subgrupo)
                };
                summaryData[budget.auc].totalBudgetMXN += budget.monto;
                summaryData[budget.auc].totalActualMXN += calcularGastoPorSubgrupo(budget.auc, budget.grupo, budget.subgrupo);
                summaryData[budget.auc].groups[budget.grupo].totalBudgetMXN += budget.monto;
                summaryData[aucCode].groups[budget.grupo].totalActualMXN += calcularGastoPorSubgrupo(budget.auc, budget.grupo, budget.subgrupo);
            });

            for (const aucCode in summaryData) {
                const aucName = aucs.find(a => a.codigo === aucCode)?.nombre || aucCode;
                const auc = summaryData[aucCode];
                const aucRemainingMXN = auc.totalBudgetMXN - auc.totalActualMXN;
                const aucProgress = auc.totalBudgetMXN > 0 ? ((auc.totalActualMXN / auc.totalBudgetMXN) * 100).toFixed(1) : 0;
                summaryRows.push({
                    'Category': `Total for ${aucName} (${aucCode})`,
                    'Budget (MXN)': auc.totalBudgetMXN,
                    'Budget (EUR)': (auc.totalBudgetMXN / tasaMXNaEUR).toFixed(2),
                    'Actual Expense (MXN)': auc.totalActualMXN,
                    'Actual Expense (EUR)': (auc.totalActualMXN / tasaMXNaEUR).toFixed(2),
                    'Remaining (MXN)': aucRemainingMXN,
                    'Remaining (EUR)': (aucRemainingMXN / tasaMXNaEUR).toFixed(2),
                    'Progress (%)': aucProgress
                });

                for (const groupName in auc.groups) {
                    const group = auc.groups[groupName];
                    const groupRemainingMXN = group.totalBudgetMXN - group.totalActualMXN;
                    const groupProgress = group.totalBudgetMXN > 0 ? ((group.totalActualMXN / group.totalBudgetMXN) * 100).toFixed(1) : 0;
                    summaryRows.push({
                        'Category': `  Total for ${groupName}`,
                        'Budget (MXN)': group.totalBudgetMXN,
                        'Budget (EUR)': (group.totalBudgetMXN / tasaMXNaEUR).toFixed(2),
                        'Actual Expense (MXN)': group.totalActualMXN,
                        'Actual Expense (EUR)': (group.totalActualMXN / tasaMXNaEUR).toFixed(2),
                        'Remaining (MXN)': groupRemainingMXN,
                        'Remaining (EUR)': (groupRemainingMXN / tasaMXNaEUR).toFixed(2),
                        'Progress (%)': groupProgress
                    });

                    for (const subgroupName in group.subgroups) {
                        const subgroup = group.subgroups[subgroupName];
                        const subgroupRemainingMXN = subgroup.budgetMXN - subgroup.actualMXN;
                        const subgroupProgress = subgroup.budgetMXN > 0 ? ((subgroup.actualMXN / subgroup.budgetMXN) * 100).toFixed(1) : 0;
                        summaryRows.push({
                            'Category': `    ${subgroupName}`,
                            'Budget (MXN)': subgroup.budgetMXN,
                            'Budget (EUR)': (subgroup.budgetMXN / tasaMXNaEUR).toFixed(2),
                            'Actual Expense (MXN)': subgroup.actualMXN,
                            'Actual Expense (EUR)': (subgroup.actualMXN / tasaMXNaEUR).toFixed(2),
                            'Remaining (MXN)': subgroupRemainingMXN,
                            'Remaining (EUR)': (subgroupRemainingMXN / tasaMXNaEUR).toFixed(2),
                            'Progress (%)': subgroupProgress
                        });
                    }
                }
            }
            dataToExport = summaryRows;
            sheetName = 'Summary';
        } else {
            displayMessage("Invalid export type.", "error");
            return;
        }

        if (dataToExport.length === 0) {
            displayMessage(`No data to export for ${sheetName}.`, "warning");
            return;
        }

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, `Project_Budget_${sheetName}_Report.xlsx`);
        displayMessage(`Exported ${sheetName} data to Excel successfully!`, "success");
    };


  // --- Application Initialization ---
  function initializeApp() {
        // IMPORTANT: Removed localStorage.removeItem() calls
        // This ensures that existing data in localStorage will be loaded automatically
        // when the page is opened again.
        
        // The lines below (aucs = JSON.parse(localStorage.getItem("aucs")) || []; etc.)
        // already handle loading existing data or starting empty if no data is found.

    renderAUCs();
    initAUCSelects();
    updateFormsAndCharts(); // This will trigger initial rendering of all tables and charts based on current state
    cargarFiltros(); // Ensure filters are populated correctly on load
  }

  // Call the initialization function... it's now implicitly called by Firebase listeners
  // when data is first loaded.
</script>
</body>
</html>
